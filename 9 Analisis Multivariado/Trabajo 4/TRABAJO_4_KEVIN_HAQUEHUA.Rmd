---
title: "MAESTRÍA EN ESTADÍSTICA"
subtitle: "ANÁLISIS MULTIVARIADO"
author: "Kevin Heberth Haquehua Apaza"
date: '02 de agosto del 2025'
output: 
  html_document:
    toc_float: true
    theme: cerulean
    toc: true
    code_download: true
    highlight: tango
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{css, echo=FALSE}
.columns {display: flex;}

/* Código para modificar los encabezados del color de la UNSAAC */
h1, h2, h3 {
  color: #7b1523;
  font-family: sans-serif;
  font-weight: bold;
}

/* Código para modificar los titulos, subtitulos, autores y fechas */
.title, .subtitle, .author, .date {
  background-color: #7b1523; 
  padding: 10px;
  text-align: center;
  font-family: sans-serif;
  font-weight: bold;
  color: white;
  display: block;
  margin: 0;
}

/* Código para modificar el texto del cuerpo del documento */
body {
  color: #7b1523;
  font-family: sans-serif;
  font-weight: normal;
  margin: 0 !important;
  padding: 0 !important;
  width: 100vw;
  height: 100vh;
  overflow-x: hidden;
}

/* Código para que el fondo de los codigos cambie de color */
pre, code {
  background-color: #F2DFDC !important;
}

/* Modificación del índice */
.tocify .tocify-item:hover {
  background-color: #F2DFDC !important;
}

/* Ocupe todo el documento */
.main-container {
  max-width: 100% !important;
}

```

```{r, echo=FALSE, out.width="100%"}
knitr::include_graphics("encabezado.png")
```

# Sección 1. Contexto y objetivo del estudio. Datos.
## Exploración de datasets
La importación de un conjunto de datos externo, en concreto uno contenido en el repositorio publico de [**Kaggle**](https://www.kaggle.com/datasets).  
Esto nos va a permitir, entre otras cosas, practicar con otras técnicas de carga de datos, más allá de la utilización de datasets contenidos en paquetes predefinidos en R.  

## Elección y Descripción del dataset
En concreto, el dataset utilizado es [**CpG Values of Smoking and Non Smoking Patients**](https://www.kaggle.com/datasets/thomaskonstantin/cpg-values-of-smoking-and-non-smoking-patients), creado por [*Thomas Konstantin*](https://www.kaggle.com/thomaskonstantin), investigador en la *Universidad de Bar-Ilan de Tel Aviv*.  

### Contexto biológico
En la página del dataset se proporciona un breve contexto acerca del contenido del mismo y el origen biológico de la información. En concreto, el dataset contiene información sobre los **niveles de metilación** en 20 **CG islands** para **671 muestras** únicas, junto con la *edad*, *género* y *código* de la muestra.
En relación a las **CG islands**, o *islas CpG*, el autor ofrece una breve explicación que tratamos de sintetizar.  
En el ADN se pueden localizar lo que se denominan *sitios CpG*, o *CpG sites*, que no son otra cosa que *di-nucleótidos* en los que una *citosina* es seguida por una *guanina*. Y a su vez, las *islas CpG* son regiones en las que hay una alta concentración de *sitios CpG*.  
Estos *dinucleótidos* pueden aparecer *metilados*, lo que significa que la *citosina* correspondiente recibe un grupo metilo (-CH3) para acabar formando una *5-metilcitosina*. Esto es importante porque las metilaciones que ocurren en un gen pueden influir en su expresión.  
El estudio de las metilaciones, y su influencia en la expresión genética, forma parte de un campo aún mayor que se denomina *epigenética*.
El autor del dataset menciona que podría ser interesante estudiar la relación entre los datos que se proporcionan de los pacientes (género, edad y condición de fumador o no fumador), y los niveles de metilación en las diferentes *CpG islands*.  
Este tipo de relaciones son precisamente las que la técnicas de análisis multivariado pueden ayudar a desentrañar. Sería interesante descubrir si se pudiese influir en el nivel de metilación de ciertas regiones del ADN, y con ello en la expresión de ciertos genes. Proporcionar este tipo de evidencias podría resultar de aplicación directa en el ámbito de la salud.  

### Cuestiones y Objetivos de Análisis
Se desconoce si las *CpG islands* de este dataset forman parte de genes o promotores de genes concretos, pero una vez localizados aquellas regiones con niveles de metilación diferenciada para diferentes condiciones, podría procederse a la identificación de las características genéticas relacionadas.  
Esa podría ser una de las preguntas que nos planteásemos: **¿existe algún CpG island cuyo nivel de metilación se vea influenciado por la condición de el género**.  
Otra cuestión podría tener que ver con la correlación entre los diferentes CpG islands. Algo del tipo: **¿están relacionados los niveles de metilación de los diferentes CpG islands?**. Esta segunda pregunta, en principio, no implicaría la búsqueda de conexión con las condiciones mencionadas anteriormente, pero podría servir para detectar relaciones ocultas en la expresión de diferentes genes y que pueden ser solucionados con la reducción de dimensionalidad como PCA o AFE.
En definitiva, las cuestiones planteadas parecen relevantes desde el punto de vista de la Bioestadística.

## Sobre del dataset
Este conjuto de datos pertenece al repositorio público de **Kaggle**, y en su descripción no se menciona ningún tipo de restricción sobre su uso. En la descripción del campo correspondiente al identificador de la muestra se indica que se corresponde con el *GSM* (*GEO accession*) de la muestra en el *NCBI*  (<https://www.ncbi.nlm.nih.gov/geo/query/acc.cgi?acc=GSM1051525>). Vemos por tanto que la información es pública y que no se define ninguna restricción de uso.  
Como curiosidad, se destaca que las referencias del *NCBI* incluyen información acerca de si se trata de un paciente con artritis reumatoide, lo que sugiere que también podríamos plantearnos cuestiones acerca de esta condición.  
En cuanto al formato, el dataset se encuentra en formato *csv*, pero el fichero de la descarga viene comprimido en formato *zip*, por lo que tendremos que descomprimirlo antes de cargarlo en un dataframe.  
Además, para evitar descargarlo cada vez que *"rendericemos"* el documento, comprobaremos si el fichero ya existe en la carpeta actual.

```{r}
# Carga de la librería para la lectura del csv
library(readr)

# URL del archivo en formato ZIP
url <- "https://www.kaggle.com/api/v1/datasets/download/thomaskonstantin/cpg-values-of-smoking-and-non-smoking-patients"

# Nombre del fichero de destino de la descarga
zip_file <- "datos.zip"

# Nombre del fichero csv
csv_file <- "Smoker_Epigenetic_df.csv"

# Comprobamos si ya se ha descargado el fichero
if (!file.exists(csv_file)) {
  message("El fichero aún no ha sido descargado. Descargando...")
  
  # Descarga del fichero
  download.file(url, destfile = zip_file, mode = "wb")
  
  # Comprobamos si la descarga fue exitosa
  if (file.exists(zip_file)) {
    # Descomprimimos el fichero zip
    csv_file <- unzip(zip_file)
    
    # Una vez descomprimido borramos el zip para liberar espacio
    file.remove(zip_file)

    message("Descarga completada correctamente.")
  } else {
    warning("Se ha producido un error en la descarga del fichero. Por favor, vuelva a intentarlo pasados unos minutos o revise su código.")
  }
} else {
  message("El archivo ya existe: ", csv_file)
}
```
Una vez descargado el dataset procedemos a cargarlo con *read_csv*.
```{r}
# Cargamos los datos desde el fichero csv
datos <- read_csv(csv_file)
```
# Sección 2. Prospección y preparación de los datos

Comenzamos con la descripción del conjunto de datos visualizando los nombres de las variables, el tamaño del dataset y la información del dataframe cargado:
```{r}
# Nombres de las columnas
names(datos)

# Dimensiones del dataset
dim(datos)

# Descripción general
str(datos)
```

A pesar de tener en la descripción del dataset *671 muestras*, en la lectura de datos obtenemos **683 muestras** esto puede ser debido a la actualización que realizó al archivo hace 4 años que también esta descrito en la página de *Kaggle* en la parte de exploración de Datos.

Podemos comparar esta información con la que obtenemos de la descripción en *Kaggle*:  

- `GSM`: El GSM (sample accession number) con el que se puede localizar la muestra en el NCBI.
- `Smoking Status`: Fumardor/a - never = nunca fumó\ current = fumador/a actualmente.
- `Gender`: Género.
- `Age`: Edad.
- `cg0XXXXXXX``: Metilación en la *CG island* correspondiente.

En la primera parte de la exploración se puede visualizar el resumen de los datos

```{r}
# Descripción general
summary(datos)
```

De la misma forma veamos la cantidad que se tiene por género estado de fumador y género.

```{r}
table(datos$`Smoking Status`)
table(datos$Gender)
```

### Información

Con la información preparada podemos identificar las clases de variables y los posibles transformaciones a realizar, el siguiente cuadro muestra un resumen de las variables planteadas a estudiar.

| Variable | Descripción | Tipo | Tamaño | Valores nulos o NA | Transformación
|:------------- |:--------------- |:-------------- |-------------- |-------------- |-------------- |
| `GSM` | Localizador de la muestra en el NCBI - ADN genómico del individuo | Identificador para localizar la muestra | 683 individuos | No se tiene | Al ser el identificador de la muestra, no es necesario realizar transformación |
| `Smoking Status` | Atributo que señala si el individuo de la muestra de estudio es fumador, ya sea que este nuna fumó o sea un fumador actual | cualitativa dicotómica | 683 individuos (490 fumadores actuales y 193 que nunca fumaron) | No se tiene | Se puede cambiar el nombre del inglés al español para interpretación de los resultados, además de que debe ser como tipo factor |
| `Gender` | Atributo que señala el género del individuo de la muestra de estudio el cual se tienen entre individuos de género femenino y género masculino | cualitativa dicotómica | 683 individuos (440 + 13 Femenino y 181 + 49 Masculino) | No se tiene | Convertir el género f y F a femenino, de la misma forma m y M a masculino y convertirlo a factor |
| `cg0XXXXXXX` | Metilación en 20 niveles o regiones genómicas en la *CpG Island* | cuantitativa continua | 683 individuos | 62 valores NA | Eliminar los valores nulos para poder proceder con el estudio |

### Transformación

Empezemos realizando la transformación correcta del género, ya que el dataset los brinda en diferentes tipos en el que se toma dos variables para femenino: f y F; de la misma forma dos para masculino: m y M. Procedamos a crear una función que realize la transformación del género

```{r}
#Función para transformar el género
genero_transformar <- function(genero) {
  if (genero == "f") {
    return("Femenino")
  } else if (genero == "F") {
    return("Femenino")
  } else if (genero == "m") {
    return("Masculino")
  } else if (genero == "M") {
    return("Masculino")
  } else {
    return("NA")
  }
}
```

Ahora apliquemos la función para transformar el género en nuestros datos

```{r}
datos$Gender <- sapply(datos$Gender, genero_transformar) #Aplicar con sapply la función creada
datos$Gender <- factor(datos$Gender) #Convertir a factor
```

Veamos ahora la distribución del género

```{r}
table(datos$Gender)
```

De la misma forma para el estado de fumador

```{r}
#Función para transformar el estado de fumador a uno en español
fumador_transformar <- function(smook) {
  if (smook == "current") {
    return("Fuma actualmente")
  } else if (smook == "never") {
    return("Nunca fumo")
  } else {
    return("NA")
  }
}
```

Ahora apliquemos la función para transformar el estado de fumador en el dataset

```{r}
datos$`Smoking Status` <- sapply(datos$`Smoking Status`, fumador_transformar) #Aplicar con sapply la función creada
datos$`Smoking Status` <- factor(datos$`Smoking Status`) #Convertir a factor
```

Veamos ahora la distribución del tipo de fumador

```{r}
table(datos$`Smoking Status`)
```

#### Verificación de valores nulos

Veamos los datos nulos en el dataset

```{r}
library(VIM)
```


```{r}
aggr(datos, col = c("navyblue", "red"), numbers = TRUE, sortVars = TRUE, 
     labels = names(datos), cex.axis = .7, gap = 3, 
     ylab = c("Distribución de datos faltantes", "Patrón"))
```

Se observa que los datos NA se encuentra en todos los valores, procedamos con la eliminación de los valores nulos, utilizando la función `na.omit()` y el operador pipe `%>%`

```{r}
library(dplyr) #Libreria a usar

datos <- datos %>% na.omit()
```

Veamos ahora un resumen de los datos

```{r}
summary(datos)
```

De los **683** registros originales que se tenía, al eliminar los valores nulos nos quedamos con **621** registros indicando que se eliminaron **62** registros. 

Teniendo ahora 621 observaciones que tienen todas las variables completas para poder ejecutar los objetivos y análisis de estudio.

## Preguntas objetivo

Tomando en cuenta el contexto explicado sobre la genómica de la metilación en los niveles de CpG island y los datos obtenidos, nos planteamos las siguientes preguntas objetivo que iremos desarrollando:

- **¿Existe relación entre los niveles de CpG island?**
- **¿Existe relación entre el sexo y la metilación de algún CpG island?**

# Sección 3. Análisis exploratorio de los datos

## Análisis descriptivo de los datos univariado

Con el objetivo de poder hallar, a primera instancia, las posibles relaciones existentes entre los niveles de metilación de los CpG Islands con respecto a las condiciones de género, es importante realizar el análisis descriptivo de los datos ya que estos nos ayudan a observar patrones y relaciones entre las variables de estudio.

Primeramente realicemos un análisis univariado de las variables, para después realizar un análisis exploratorio multivariado.

```{r}
library(skimr)
skim(datos)
```

Se observa una distribución en cada valor de los niveles de CpG island, generalmente sin aproximarse a una distribución normal con diferentes niveles, veamos de forma multivariada

## Análisis multivariado

```{r}
stars(datos[c(1:50),c(5:20)],key.loc=c(-5,20),lwd=1)  # muestra digrama de estrellas
```


Veamos que hay ciertos valores que presentan un patrón similar, en general que pueden ser diferenciados con las técnicas de análisis multivariado.

# Sección 4. Análisis factorial exploratorio

Para este caso se usará el análisis factorial exploratorio para ver si hay relaciones en los niveles de metilación de CpG Island, asimismo para reducir su dimensionalidad y aplicar un modelo de regresión logística, extrayendo las variables numéricas de metilación

```{r}
metilacion <- datos[,5:24]
```


## Prueba de esfericidad de Bartlet

```{r}
library(psych)
cortest.bartlett(cor(metilacion), n=nrow(metilacion))
```

Se nos muestra un p valor menor a 0.05, justifica el uso de reducción de datos.

## Indicador Kaiser-Meyer-Olkinn KMO y MSA

```{r}
KMO(metilacion)
```

Todos los valores son menores a 0.5 considerando aceptable la aplicación del análisis factorial al conjunto de datos

Empezemos realizando la primera seleccionando tomando en cuenta todos los factores

```{r}
facto=principal(r=metilacion,nfactors=20,rotate="varimax")
facto
facto$loadings
```

Por la mayor explicación de la varianza, se recomienda usar 3 o 4 factores, utilizemos 3 factores

```{r}
facto=principal(r=metilacion,nfactors=3,rotate="varimax")
facto
facto$loadings
```

Para este caso no se interpretará los componentes, para el objetivo solo se extraerá los factores loadings, se estandarizará y posteriormente se aplicará la regresión logística para la clasificación del género.

```{r}
biplot(prcomp(metilacion, scale = FALSE))
abline(h = 0, v = 0, lty = 2, col = 8)
```

Como se observa hay mejor distinción de las variables con respecto a sus factores.

## Extracción y transformación de los factores

Saquemos ahora los scores

```{r}
scores <- as.matrix(metilacion) %*% as.matrix(facto$loadings)
scores <- data.frame(scores) ; head(scores)
```

Realizemos una transformación manteniendo sus características, para este caso en lugar de realizar la tranformacion por la estandarización normal, se aplicará mínimos y máximos para que tenga interpretabilidad con los porcentajes de metilación de CpG Island

```{r}
library(scales)
```


```{r}
scores$RC1 <- rescale(scores$RC1, to = c(0,1))
scores$RC3 <- rescale(scores$RC3, to = c(0,1))
scores$RC2 <- rescale(scores$RC2, to = c(0,1))
```

**Interpretación:** Se observa que con los 3 factores se puede explicar el 85.3% de la variabilidad. Esto indica que la variable a estudiar puede ser fácilmente explicada a través de tres factores de tal forma que se reduzca la dimensionalidad de 20 niveles de metilación a CpG a solo tres factores que puedan explicar el 85.3% de la variabilidad de estos niveles.

# Sección 5. Regresión logística

Empezemos realizando la unión de los datos originales con los tres factores para aplicar una regresión logística y ver si se realizar una clasificación de los niveles de metilación de CpG Island con respecto al género.

```{r}
data_AFE <- cbind(datos,scores)
data_AFE <- data_AFE %>% select(Gender, RC1, RC2, RC3)
head(data_AFE)
```

Previamente veamos en un gráfico de cajas los diferentes factores y la clasificación del género

## Visualización de los factores y el género

```{r}
par(mfrow = c(1,3))
boxplot(RC1 ~ Gender, data = data_AFE)
boxplot(RC2 ~ Gender, data = data_AFE)
boxplot(RC3 ~ Gender, data = data_AFE)
```

Se observan diferencias entre ambos grupos con respecto a los niveles de metilación de CpG Island

```{r}
par(mfrow = c(1,1))
```

## Aplicación del modelo logístico

Veamos el modelo logístico

```{r}
modelo_logistic <- glm(Gender ~ ., family=binomial,data=data_AFE)
summary(modelo_logistic)
```

En este caso hay un notorio sobreajuste de los datos, ya que como se observa la diferenciación entre grupos es muy evidente. veamos con la ayuda de stepAIC

```{r}
library(MASS)
modelo_logistic <- stepAIC(modelo_logistic)
summary(modelo_logistic)
```

Con el modelo saquemos los errores de clasificación

```{r}
yprob<-predict(modelo_logistic,type="response")
head(yprob)
```

## Matriz de confusión

```{r}
ypred <- as.numeric(yprob >= 0.5 )
ypred <- factor(ypred, labels = levels(data_AFE$Gender))

# Matriz de Confusión
(mc<-table(ypred,data_AFE$Gender))
```


Se observa que el modelo realizó una clasificación perfecta para la data de testeo con respecto a los 20 niveles de metilación de CG island y el género, esto también se mostró de forma gráfica ya que había un patrón de acumulación en el nivel de metilación con respecto al género.
